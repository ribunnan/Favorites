<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>私のリンクコレクション</title>
  <!-- 引入 Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* 新主题设置 */
    :root {
      --bg-color: #202124;
      --text-color: #E8EAED;
      --container-bg: #303134;
      --border-color: #5f6368;
      --link-color: #8ab4f8;
      --btn-bg: #8ab4f8;
      --btn-bg-hover: #669df6;
      --shadow-color: rgba(0, 0, 0, 0.7);
    }
    .light-theme {
      --bg-color: #F1F3F4;
      --text-color: #202124;
      --container-bg: #FFFFFF;
      --border-color: #dadce0;
      --link-color: #1a73e8;
      --btn-bg: #1a73e8;
      --btn-bg-hover: #1558b0;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      transition: background-color 0.4s, color 0.4s;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.3) 0%, transparent 80%);
      z-index: -1;
    }
    
    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      background-color: var(--container-bg);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
    }
    
    h1 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 30px;
    }
    
    /* 工具栏 */
    .toolbar {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 30px;
    }
    .toolbar input.form-control {
      flex: 1 1 240px;
      max-width: 400px;
      height: 44px;
      padding: 0 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--container-bg);
      color: var(--text-color);
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    .toolbar input.form-control:focus {
      border-color: var(--btn-bg);
      outline: none;
    }
    /* 工具栏按钮顺序：添加链接、导出数据、导入数据、主题切换、注销、（管理员按钮） */
    .toolbar button {
      height: 44px;
      padding: 0 15px;
      border: none;
      border-radius: 6px;
      background-color: var(--btn-bg);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s, transform 0.2s;
    }
    .toolbar button:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-3px);
    }
    
    hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 30px 0;
    }
    
    /* 链接卡片 */
    .link-card {
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 3px 10px var(--shadow-color);
      transition: transform 0.2s;
    }
    .link-card:hover {
      transform: translateY(-3px);
    }
    .link-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .link-icon {
      width: 32px;
      height: 32px;
      margin-right: 15px;
      border-radius: 4px;
      object-fit: cover;
    }
    .link-info {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      flex: 1;
    }
    .link-info a {
      color: var(--link-color);
      text-decoration: none;
      font-size: 20px;
      font-weight: 500;
      margin-right: 10px;
    }
    .link-info a:hover {
      text-decoration: underline;
    }
    .tag {
      background-color: var(--border-color);
      color: var(--text-color);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background-color: var(--border-color);
      color: var(--text-color);
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      margin-right: 10px;
      margin-top: 10px;
      font-size: 14px;
    }
    .btn:hover {
      background-color: var(--btn-bg-hover);
      color: #fff;
      transform: translateY(-2px);
    }
    
    .edit-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .edit-input {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--container-bg);
      color: var(--text-color);
      transition: border-color 0.3s;
    }
    .edit-input:focus {
      border-color: var(--btn-bg);
      outline: none;
    }
    
    /* 登录/注册认证模态框 */
    #authModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 20px;
      z-index: 2100;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
    }
    #authModal h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
    }
    #authModal .modal-btns {
      text-align: right;
      margin-top: 20px;
    }
    #authModal .modal-btns button {
      margin-left: 10px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-size: 14px;
    }
    #authModal .modal-btns .btn {
      background-color: var(--border-color);
      color: var(--text-color);
    }
    #authModal .modal-btns .btn:hover {
      background-color: var(--btn-bg-hover);
      color: #fff;
      transform: translateY(-2px);
    }
    #authModal .modal-btns .btn-add {
      background-color: var(--btn-bg);
      color: #fff;
    }
    #authModal .modal-btns .btn-add:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-2px);
    }
    
    /* Modal 遮罩 */
    #modalOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2050;
      display: none;
    }
    
    /* 添加链接模态框 */
    #addLinkModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 20px;
      z-index: 2100;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
    }
    #addLinkModal h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
    }
    #addLinkModal .modal-btns {
      text-align: right;
      margin-top: 20px;
    }
    #addLinkModal .modal-btns button {
      margin-left: 10px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-size: 14px;
    }
    #addLinkModal .modal-btns .btn {
      background-color: var(--border-color);
      color: var(--text-color);
    }
    #addLinkModal .modal-btns .btn:hover {
      background-color: var(--btn-bg-hover);
      color: #fff;
      transform: translateY(-2px);
    }
    #addLinkModal .modal-btns .btn-add {
      background-color: var(--btn-bg);
      color: #fff;
    }
    #addLinkModal .modal-btns .btn-add:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-2px);
    }
    
    /* 管理员模态框 */
    #adminModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      padding: 20px;
      z-index: 2200;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
      max-height: 80vh;
      overflow-y: auto;
    }
    #adminModal h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
    }
    #adminModal table {
      width: 100%;
      border-collapse: collapse;
    }
    #adminModal th, #adminModal td {
      padding: 8px;
      border: 1px solid var(--border-color);
      text-align: left;
      font-size: 14px;
    }
    #adminModal th {
      background-color: var(--btn-bg);
      color: #fff;
    }
    #adminModal .modal-btns {
      text-align: right;
      margin-top: 20px;
    }
    #adminModal .modal-btns button {
      margin-left: 10px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-size: 14px;
    }
    #adminModal .modal-btns .btn {
      background-color: var(--border-color);
      color: var(--text-color);
    }
    #adminModal .modal-btns .btn:hover {
      background-color: var(--btn-bg-hover);
      color: #fff;
      transform: translateY(-2px);
    }
    #adminModal .modal-btns .btn-add {
      background-color: var(--btn-bg);
      color: #fff;
    }
    #adminModal .modal-btns .btn-add:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- 认证模态框（登录/注册） -->
  <div id="authModal" style="display:none;">
    <!-- 登录表单 -->
    <div id="loginForm">
      <h2>ログイン</h2>
      <input type="text" id="loginUsername" class="form-control" placeholder="ユーザー名">
      <input type="password" id="loginPassword" class="form-control" placeholder="パスワード">
      <div class="modal-btns">
        <button class="btn" onclick="switchToRegister()">登録</button>
        <button class="btn-add" onclick="login()">ログイン</button>
      </div>
    </div>
    <!-- 注册表单 -->
    <div id="registerForm" style="display:none;">
      <h2>登録</h2>
      <input type="text" id="registerUsername" class="form-control" placeholder="ユーザー名">
      <input type="password" id="registerPassword" class="form-control" placeholder="パスワード">
      <input type="password" id="registerPasswordConfirm" class="form-control" placeholder="パスワード確認">
      <div class="modal-btns">
        <button class="btn" onclick="switchToLogin()">ログインに戻る</button>
        <button class="btn-add" onclick="register()">登録</button>
      </div>
    </div>
  </div>
  <!-- Modal 遮罩 -->
  <div id="modalOverlay" style="display:none;"></div>

  <!-- 主页面 -->
  <div class="container" id="mainContent">
    <h1>私のリンクコレクション</h1>
    <!-- 工具栏：搜索框 与 按钮（顺序：添加链接、导出数据、导入数据、主题切换、注销、管理员） -->
    <div class="toolbar">
      <input type="text" id="searchInput" class="form-control" placeholder="リンクを検索...">
      <button onclick="openAddModal()">リンク追加</button>
      <button onclick="exportLinks()">データエクスポート</button>
      <button onclick="document.getElementById('importInput').click();">データインポート</button>
      <button id="themeToggle">テーマ切替</button>
      <button onclick="logout()">ログアウト</button>
      <button id="adminBtn" onclick="openAdminModal()" style="display:none;">管理</button>
      <input type="file" id="importInput" style="display:none" accept="application/json">
    </div>
    <!-- 链接列表 -->
    <div id="linksList"></div>
  </div>

  <!-- 添加链接模态框 -->
  <div id="addLinkModal" style="display:none;">
    <h2>新規リンク追加</h2>
    <input type="text" id="modalLinkName" class="form-control" placeholder="リンク名">
    <input type="url" id="modalLinkURL" class="form-control" placeholder="リンクURL（http:// または https:// を含む）">
    <input type="text" id="modalLinkTags" class="form-control" placeholder="タグ（複数の場合、コンマで区切ってください）">
    <div class="modal-btns">
      <button class="btn" onclick="closeAddModal()">キャンセル</button>
      <button class="btn-add" onclick="submitNewLink()">送信</button>
    </div>
  </div>

  <!-- 管理员模态框 -->
  <div id="adminModal" style="display:none;">
    <h2>ユーザー管理</h2>
    <table id="adminTable">
      <thead>
        <tr>
          <th>ユーザー名</th>
          <th>パスワード</th>
          <th>最終ログイン</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <!-- 管理者用にユーザー情報が動的に表示されます -->
      </tbody>
    </table>
    <div class="modal-btns">
      <button class="btn" onclick="downloadAllUserLinks()">全ユーザーのリンクダウンロード</button>
      <button class="btn" onclick="closeAdminModal()">閉じる</button>
    </div>
  </div>
  
  <!-- 引入 Sortable.js -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script>
    /* =========== 用户注册与登录功能 =========== */
    // 获取或初始化用户数据（保存于 localStorage "users"，格式：{ username: { password: "...", links: [...], lastLogin:"..." } }）
    function getUsers() {
      return JSON.parse(localStorage.getItem("users") || "{}");
    }
    function setUsers(users) {
      localStorage.setItem("users", JSON.stringify(users));
    }
    // 获取当前登录用户名（保存于 localStorage "currentUser"）
    function getCurrentUser() {
      return localStorage.getItem("currentUser");
    }
    function setCurrentUser(username) {
      localStorage.setItem("currentUser", username);
    }
    function removeCurrentUser() {
      localStorage.removeItem("currentUser");
    }
    // 确保默认管理员账户存在
    function ensureAdminAccount() {
      let users = getUsers();
      if (!users["liwennan"]) {
        users["liwennan"] = { password: "64664644", links: [], lastLogin: "" };
        setUsers(users);
      }
    }
    ensureAdminAccount();
    
    // 页面加载时检查登录状态
    window.onload = function() {
      if (!getCurrentUser()) {
        openAuthModal(); // 显示认证模态框
        document.getElementById("mainContent").style.display = "none";
      } else {
        loadUserLinks();
        document.getElementById("mainContent").style.display = "block";
        // 如果当前用户为管理员，则显示管理按钮
        if (getCurrentUser() === "liwennan") {
          document.getElementById("adminBtn").style.display = "inline-block";
        } else {
          document.getElementById("adminBtn").style.display = "none";
        }
      }
    };
    
    // 显示认证模态框
    function openAuthModal() {
      document.getElementById("authModal").style.display = "block";
      document.getElementById("modalOverlay").style.display = "block";
    }
    // 隐藏认证模态框
    function closeAuthModal() {
      document.getElementById("authModal").style.display = "none";
      document.getElementById("modalOverlay").style.display = "none";
    }
    
    // 切换到注册表单
    function switchToRegister() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "block";
    }
    // 切换到登录表单
    function switchToLogin() {
      document.getElementById("registerForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    }
    
    // 登录操作
    function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!username || !password) {
        alert("すべての情報を入力してください！");
        return;
      }
      const users = getUsers();
      if (users[username] && users[username].password === password) {
        setCurrentUser(username);
        // 更新最后登录时间
        users[username].lastLogin = new Date().toISOString();
        setUsers(users);
        if (!users[username].links) {
          users[username].links = [];
          setUsers(users);
        }
        loadUserLinks();
        closeAuthModal();
        document.getElementById("mainContent").style.display = "block";
        if (username === "liwennan") {
          document.getElementById("adminBtn").style.display = "inline-block";
        } else {
          document.getElementById("adminBtn").style.display = "none";
        }
      } else {
        alert("ユーザー名またはパスワードが間違っています！");
      }
    }
    
    // 注册操作
    function register() {
      const username = document.getElementById("registerUsername").value.trim();
      const password = document.getElementById("registerPassword").value;
      const confirmPassword = document.getElementById("registerPasswordConfirm").value;
      if (!username || !password || !confirmPassword) {
        alert("すべての情報を入力してください！");
        return;
      }
      if (password !== confirmPassword) {
        alert("パスワードが一致しません！");
        return;
      }
      const users = getUsers();
      if (users[username]) {
        alert("そのユーザー名は既に存在します！");
        return;
      }
      users[username] = { password: password, links: [], lastLogin: new Date().toISOString() };
      setUsers(users);
      setCurrentUser(username);
      loadUserLinks();
      closeAuthModal();
      document.getElementById("mainContent").style.display = "block";
      if (username === "liwennan") {
        document.getElementById("adminBtn").style.display = "inline-block";
      } else {
        document.getElementById("adminBtn").style.display = "none";
      }
    }
    
    // 注销操作
    function logout() {
      removeCurrentUser();
      links = [];
      renderLinks();
      openAuthModal();
      document.getElementById("mainContent").style.display = "none";
    }
    
    /* =========== 收藏链接功能（与之前代码类似，但与当前用户关联） =========== */
    let links = []; // 当前用户的链接数组
    
    // 从当前用户数据中加载链接
    function loadUserLinks() {
      const currentUser = getCurrentUser();
      const users = getUsers();
      links = users[currentUser].links || [];
    }
    // 保存当前用户的链接数据
    function saveUserLinks() {
      const currentUser = getCurrentUser();
      const users = getUsers();
      users[currentUser].links = links;
      setUsers(users);
    }
    
    // 辅助函数：获取 favicon URL
    function getFaviconUrl(linkUrl) {
      try {
        const urlObj = new URL(linkUrl);
        return 'https://www.google.com/s2/favicons?sz=64&domain_url=' + urlObj.hostname;
      } catch (e) {
        return '';
      }
    }
    // 默认 fallback 图标
    const fallbackIcon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Crect width='32' height='32' fill='%23cccccc' rx='4'/%3E%3Ctext x='16' y='21' font-size='10' text-anchor='middle' fill='%23666666'%3ENo Icon%3C/text%3E%3C/svg%3E";
    
    // 创建链接卡片
    function createLinkCard(link, index) {
      const card = document.createElement('div');
      card.className = 'link-card';
      card.setAttribute('data-index', index);
      
      const header = document.createElement('div');
      header.className = 'link-header';
      
      const icon = document.createElement('img');
      icon.className = 'link-icon';
      icon.src = getFaviconUrl(link.url);
      icon.alt = 'favicon';
      icon.onerror = function() {
        this.onerror = null;
        this.src = fallbackIcon;
      };
      header.appendChild(icon);
      
      const info = document.createElement('div');
      info.className = 'link-info';
      
      const linkElem = document.createElement('a');
      linkElem.href = link.url;
      linkElem.textContent = link.name;
      linkElem.target = '_blank';
      info.appendChild(linkElem);
      
      if (link.tags && link.tags.length > 0) {
        link.tags.forEach(tag => {
          const tagElem = document.createElement('span');
          tagElem.className = 'tag';
          tagElem.textContent = tag;
          info.appendChild(tagElem);
        });
      }
      
      header.appendChild(info);
      card.appendChild(header);
      
      const btnContainer = document.createElement('div');
      
      const editButton = document.createElement('button');
      editButton.textContent = '編集';
      editButton.className = 'btn';
      editButton.onclick = function() {
        enterEditMode(card, link, index);
      };
      btnContainer.appendChild(editButton);
      
      const deleteButton = document.createElement('button');
      deleteButton.textContent = '削除';
      deleteButton.className = 'btn';
      deleteButton.onclick = function() {
        if (confirm('このリンクを削除してもよろしいですか？')) {
          links.splice(index, 1);
          saveUserLinks();
          renderLinks();
        }
      };
      btnContainer.appendChild(deleteButton);
      
      card.appendChild(btnContainer);
      return card;
    }
    
    // 进入编辑模式
    function enterEditMode(card, link, index) {
      card.innerHTML = '';
      const editContainer = document.createElement('div');
      editContainer.className = 'edit-container';
      
      const nameInput = document.createElement('input');
      nameInput.value = link.name;
      nameInput.className = 'edit-input';
      nameInput.placeholder = 'リンク名';
      editContainer.appendChild(nameInput);
      
      const urlInput = document.createElement('input');
      urlInput.value = link.url;
      urlInput.className = 'edit-input';
      urlInput.placeholder = 'リンクURL（http:// または https:// を含む）';
      editContainer.appendChild(urlInput);
      
      const tagsInput = document.createElement('input');
      tagsInput.value = link.tags ? link.tags.join(', ') : '';
      tagsInput.className = 'edit-input';
      tagsInput.placeholder = 'タグ（複数の場合、コンマで区切ってください）';
      editContainer.appendChild(tagsInput);
      
      card.appendChild(editContainer);
      
      const saveButton = document.createElement('button');
      saveButton.textContent = '保存';
      saveButton.className = 'btn';
      saveButton.onclick = function() {
        const newName = nameInput.value.trim();
        const newURL = urlInput.value.trim();
        const newTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        if (newName && newURL) {
          links[index] = { name: newName, url: newURL, tags: newTags };
          saveUserLinks();
          renderLinks();
        } else {
          alert("リンク名とURLは空にできません！");
        }
      };
      card.appendChild(saveButton);
      
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'キャンセル';
      cancelButton.className = 'btn';
      cancelButton.onclick = function() {
        renderLinks();
      };
      card.appendChild(cancelButton);
    }
    
    // 渲染链接列表
    function renderLinks(filteredLinks = null) {
      const listContainer = document.getElementById('linksList');
      listContainer.innerHTML = '';
      let displayLinks = filteredLinks !== null ? filteredLinks : links;
      displayLinks.forEach((link, index) => {
        const card = createLinkCard(link, index);
        listContainer.appendChild(card);
      });
      
      if (!document.getElementById('searchInput').value.trim()) {
        new Sortable(listContainer, {
          animation: 150,
          onEnd: function(evt) {
            const oldIndex = evt.oldIndex;
            const newIndex = evt.newIndex;
            links.splice(newIndex, 0, links.splice(oldIndex, 1)[0]);
            saveUserLinks();
            renderLinks();
          }
        });
      }
    }
    
    // Modal 操作：添加链接
    function openAddModal() {
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById('addLinkModal').style.display = 'block';
      document.getElementById('modalLinkName').value = '';
      document.getElementById('modalLinkURL').value = '';
      document.getElementById('modalLinkTags').value = '';
    }
    function closeAddModal() {
      document.getElementById('modalOverlay').style.display = 'none';
      document.getElementById('addLinkModal').style.display = 'none';
    }
    function submitNewLink() {
      const name = document.getElementById('modalLinkName').value.trim();
      const url = document.getElementById('modalLinkURL').value.trim();
      const tagsRaw = document.getElementById('modalLinkTags').value.trim();
      const tags = tagsRaw ? tagsRaw.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
      if (!name || !url) {
        alert("すべての情報を入力してください！");
        return;
      }
      // 重复链接检测（按 URL 或名称匹配，不区分大小写）
      const duplicateIndex = links.findIndex(l => 
        l.url.toLowerCase() === url.toLowerCase() || l.name.toLowerCase() === name.toLowerCase()
      );
      if (duplicateIndex !== -1) {
        if (confirm("重複したリンクが検出されました。既存のリンク情報と統合して更新しますか？")) {
          const existingTags = links[duplicateIndex].tags || [];
          const mergedTags = Array.from(new Set([...existingTags, ...tags]));
          links[duplicateIndex] = { name: name, url: url, tags: mergedTags };
          saveUserLinks();
          renderLinks();
          closeAddModal();
        } else {
          return;
        }
      } else {
        links.push({ name: name, url: url, tags: tags });
        saveUserLinks();
        renderLinks();
        closeAddModal();
      }
    }
    
    // 搜索功能：匹配链接名称、链接地址和标签
    document.getElementById('searchInput').addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      const filtered = links.filter(link => {
        const nameMatch = link.name.toLowerCase().includes(query);
        const urlMatch = link.url.toLowerCase().includes(query);
        const tagMatch = link.tags && link.tags.some(tag => tag.toLowerCase().includes(query));
        return nameMatch || urlMatch || tagMatch;
      });
      renderLinks(filtered);
    });
    
    // 导出数据（仅当前用户收藏数据）
    function exportLinks() {
      const dataStr = JSON.stringify(links, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "links_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // 导入数据（导入后替换当前用户收藏数据）
    document.getElementById('importInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedLinks = JSON.parse(e.target.result);
          if (Array.isArray(importedLinks)) {
            links = importedLinks;
            saveUserLinks();
            renderLinks();
            alert("データのインポートに成功しました！");
          } else {
            alert("データ形式が正しくありません！");
          }
        } catch (err) {
          alert("インポートに失敗しました。ファイル形式が正しくありません！");
        }
      };
      reader.readAsText(file);
    });
    
    /* =========== 管理员功能 =========== */
    // 管理员模态框操作
    function openAdminModal() {
      renderAdminData();
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById('adminModal').style.display = 'block';
    }
    function closeAdminModal() {
      document.getElementById('modalOverlay').style.display = 'none';
      document.getElementById('adminModal').style.display = 'none';
    }
    
    // 渲染管理员数据（所有用户信息）
    function renderAdminData() {
      // 检查表格 tbody 是否存在
      let adminTable = document.getElementById('adminTable');
      if (!adminTable) {
        // 若未找到表格则创建一个新的（本示例代码中表格已在 HTML 中定义）
        return;
      }
      let adminTableBody = adminTable.getElementsByTagName('tbody')[0];
      if (!adminTableBody) {
        adminTableBody = document.createElement('tbody');
        adminTable.appendChild(adminTableBody);
      }
      adminTableBody.innerHTML = ""; // 清空旧内容
      const users = getUsers();
      for (let username in users) {
        const user = users[username];
        const row = document.createElement("tr");
        
        // 用户名单元格（可编辑）
        const usernameCell = document.createElement("td");
        const usernameInput = document.createElement("input");
        usernameInput.value = username;
        usernameInput.style.width = "100%";
        usernameCell.appendChild(usernameInput);
        row.appendChild(usernameCell);
        
        // 密码单元格（可编辑）
        const passwordCell = document.createElement("td");
        const passwordInput = document.createElement("input");
        passwordInput.value = user.password;
        passwordInput.style.width = "100%";
        passwordCell.appendChild(passwordInput);
        row.appendChild(passwordCell);
        
        // 最后登录时间
        const loginTimeCell = document.createElement("td");
        loginTimeCell.textContent = user.lastLogin || "";
        row.appendChild(loginTimeCell);
        
        // 操作单元格
        const actionCell = document.createElement("td");
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "保存";
        saveBtn.className = "btn";
        saveBtn.onclick = function() {
          const newUsername = usernameInput.value.trim();
          const newPassword = passwordInput.value.trim();
          if (!newUsername || !newPassword) {
            alert("ユーザー名とパスワードは空にできません！");
            return;
          }
          // 更新用户数据：若用户名改变，则重建用户项
          if (newUsername !== username) {
            const allUsers = getUsers();
            if (allUsers[newUsername]) {
              alert("そのユーザー名は既に存在します！");
              return;
            }
            allUsers[newUsername] = { ...allUsers[username], password: newPassword };
            delete allUsers[username];
            setUsers(allUsers);
          } else {
            const allUsers = getUsers();
            allUsers[username].password = newPassword;
            setUsers(allUsers);
          }
          renderAdminData();
          alert("保存に成功しました！");
        };
        actionCell.appendChild(saveBtn);
        row.appendChild(actionCell);
        
        adminTableBody.appendChild(row);
      }
    }
    
    // 下载所有用户收藏（所有账户的 links 数据）
    function downloadAllUserLinks() {
      const users = getUsers();
      const dataStr = JSON.stringify(users, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "all_users_links.json";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
