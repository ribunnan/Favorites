<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>リンク集</title>
  <!-- 引入 Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Firebase SDK（compat 版） -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <!-- 使用 xlsx‑style 以尽量保留格式和公式（建议模板为 .xlsx 格式） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-style/0.8.13/xlsx.full.min.js"></script>

  <style>
    /* 新主题设置 */
    :root {
      --bg-color: #202124;
      --text-color: #E8EAED;
      --container-bg: #303134;
      --border-color: #5f6368;
      --link-color: #8ab4f8;
      --btn-bg: #8ab4f8;
      --btn-bg-hover: #669df6;
      --shadow-color: rgba(0, 0, 0, 0.7);
    }
    .light-theme {
      --bg-color: #F1F3F4;
      --text-color: #202124;
      --container-bg: #FFFFFF;
      --border-color: #dadce0;
      --link-color: #1a73e8;
      --btn-bg: #1a73e8;
      --btn-bg-hover: #1558b0;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      transition: background-color 0.4s, color 0.4s;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.3) 0%, transparent 80%);
      z-index: -1;
    }
    
    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 30px;
      background-color: var(--container-bg);
      border-radius: 12px;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
      position: relative;
    }
    
    h1 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 30px;
      padding-top: 60px; /* 为了防止顶部按钮与标题重叠 */
    }
    
    /* 顶部右上角按钮 */
    .top-right-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .top-right-buttons button {
      margin: 0;
      flex: none;
    }
    /* 新增“勤務表作成”按钮设置 */
    #workSheetBtn {
      background-color: #4CAF50; /* 绿色 */
    }
    
    /* 工具栏 */
    .toolbar {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 30px;
    }
    .toolbar input.form-control {
      flex: 1 1 240px;
      max-width: 400px;
      height: 44px;
      padding: 0 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--container-bg);
      color: var(--text-color);
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    .toolbar input.form-control:focus {
      border-color: var(--btn-bg);
      outline: none;
    }
    .toolbar button {
      height: 44px;
      padding: 0 15px;
      border: none;
      border-radius: 6px;
      background-color: var(--btn-bg);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s, transform 0.2s;
    }
    .toolbar button:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-3px);
    }
    
    hr {
      border: none;
      height: 1px;
      background-color: var(--border-color);
      margin: 30px 0;
    }
    
    /* 链接卡片 */
    .link-card {
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 3px 10px var(--shadow-color);
      transition: transform 0.2s;
    }
    .link-card:hover {
      transform: translateY(-3px);
    }
    .link-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .link-icon {
      width: 32px;
      height: 32px;
      margin-right: 15px;
      border-radius: 4px;
      object-fit: cover;
    }
    .link-info {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      flex: 1;
    }
    .link-info a {
      color: var(--link-color);
      text-decoration: none;
      font-size: 20px;
      font-weight: 500;
      margin-right: 10px;
    }
    .link-info a:hover {
      text-decoration: underline;
    }
    .tag {
      background-color: var(--border-color);
      color: var(--text-color);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    
    /* 统一按钮样式 */
    .btn, .btn-add {
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      background-color: var(--btn-bg);
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-size: 14px;
      margin: 5px 0;
    }
    .btn:hover, .btn-add:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-2px);
    }
    .link-btn {
      margin-right: 8px;
    }
    
    .edit-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }
    .edit-input {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--container-bg);
      color: var(--text-color);
      transition: border-color 0.3s;
    }
    .edit-input:focus {
      border-color: var(--btn-bg);
      outline: none;
    }
    
    /* 认证/注册 模态框 */
    #authModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 20px;
      z-index: 2100;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
    }
    #authModal h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
    }
    .modal-btns-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    
    /* 模态框遮罩层 */
    #modalOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2050;
      display: none;
    }
    
    /* 链接新增 模态框 */
    #addLinkModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 20px;
      z-index: 2100;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
    }
    #addLinkModal h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
    }
    #addLinkModal .modal-btns {
      text-align: right;
      margin-top: 20px;
    }
    #addLinkModal .modal-btns button {
      margin-left: 10px;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-size: 14px;
    }
    #addLinkModal .modal-btns .btn {
      background-color: var(--btn-bg);
      color: #fff;
    }
    #addLinkModal .modal-btns .btn:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-2px);
    }
    
    /* 管理者 模态框 */
    #adminModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      padding: 15px;
      z-index: 2200;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
      max-height: 80vh;
      overflow-y: auto;
    }
    #adminModal h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
    }
    #adminModal table {
      width: 100%;
      border-collapse: collapse;
    }
    #adminModal th, #adminModal td {
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      text-align: left;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    #adminModal th {
      background-color: var(--btn-bg);
      color: #fff;
    }
    #adminModal .modal-btns {
      text-align: right;
      margin-top: 20px;
    }
    #adminModal .modal-btns button {
      margin-left: 10px;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      font-size: 14px;
    }
    #adminModal .modal-btns .btn {
      background-color: var(--btn-bg);
      color: #fff;
    }
    #adminModal .modal-btns .btn:hover {
      background-color: var(--btn-bg-hover);
      transform: translateY(-2px);
    }
    
    /* 勤務表作成 模态框 */
    #workSheetModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      padding: 20px;
      z-index: 2200;
      box-shadow: 0 6px 20px var(--shadow-color);
      display: none;
    }
    #workSheetModal h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
    }
    #workSheetModal .modal-btns {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    #workSheetModal label {
      display: block;
      margin-top: 10px;
    }
    #workSheetModal input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--container-bg);
      color: var(--text-color);
      box-sizing: border-box;
    }
    
    /* 登录等待 Spinner */
    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border-left-color: var(--btn-bg);
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ======= 移动端响应式设计 ======= */
    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      h1 {
        font-size: 24px;
        padding-top: 80px; /* 增加上边距以确保标题下移，不与顶部按钮重叠 */
      }
      .top-right-buttons {
        position: static;
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .toolbar input.form-control {
        height: 36px;
        padding: 8px;
        font-size: 14px;
      }
      .toolbar button {
        height: 36px;
        padding: 8px 12px;
        font-size: 12px;
      }
      .link-card {
        padding: 15px;
      }
      .modal-btns-row, #workSheetModal .modal-btns {
        flex-direction: column;
        align-items: stretch;
      }
      .modal-btns-row button, #workSheetModal .modal-btns button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- 认证/注册 模态框 -->
  <div id="authModal" style="display:none;">
    <!-- 登录表单 -->
    <div id="loginForm">
      <h2>ログイン</h2>
      <input type="text" id="loginUsername" class="form-control" placeholder="メールアドレス">
      <input type="password" id="loginPassword" class="form-control" placeholder="パスワード">
      <div class="modal-btns-row">
        <button class="btn-add" id="loginButton" onclick="login()">ログイン</button>
        <button class="btn-add" onclick="switchToRegister()">アカウント作成</button>
      </div>
      <div style="text-align: center;">
        <div id="loginSpinner" class="spinner" style="display:none;"></div>
      </div>
    </div>
    <!-- 注册表单 -->
    <div id="registerForm" style="display:none;">
      <h2>登録</h2>
      <input type="text" id="registerUsername" class="form-control" placeholder="メールアドレス">
      <input type="password" id="registerPassword" class="form-control" placeholder="パスワード">
      <input type="password" id="registerPasswordConfirm" class="form-control" placeholder="パスワード確認">
      <div class="modal-btns-row">
        <button class="btn-add" onclick="register()">登録</button>
        <button class="btn-add" onclick="switchToLogin()">ログインに戻る</button>
      </div>
    </div>
  </div>
  
  <!-- 模态框遮罩层 -->
  <div id="modalOverlay" style="display:none;"></div>
  
  <!-- 勤務表作成 模态框 -->
  <div id="workSheetModal" style="display:none;">
    <h2>勤務表作成</h2>
    <label for="wsLastName">姓（例：山田）</label>
    <input type="text" id="wsLastName" placeholder="姓">
    <label for="wsFirstName">名（例：太郎）</label>
    <input type="text" id="wsFirstName" placeholder="名">
    <label for="wsPeriod">勤務表期間（年月）</label>
    <input type="month" id="wsPeriod">
    <div class="modal-btns">
      <button class="btn" onclick="closeWorkSheetModal()">キャンセル</button>
      <button class="btn-add" onclick="downloadWorkSheet()">ダウンロード</button>
    </div>
  </div>
  
  <!-- 主页面 -->
  <div class="container" id="mainContent">
    <!-- 顶部右上角按钮 -->
    <div class="top-right-buttons">
      <button id="adminBtn" onclick="openAdminModal()" style="display:none;">管理</button>
      <button id="workSheetBtn" onclick="openWorkSheetModal()">勤務表作成</button>
      <button onclick="confirmLogout()">ログアウト</button>
    </div>
    <h1>リンク集</h1>
    <!-- 工具栏 -->
    <div class="toolbar">
      <input type="text" id="searchInput" class="form-control" placeholder="リンクを検索...">
      <button onclick="openAddModal()">リンク追加</button>
      <button onclick="exportLinks()">データエクスポート</button>
      <button onclick="document.getElementById('importInput').click();">データインポート</button>
      <button id="themeToggle">テーマ切替</button>
      <input type="file" id="importInput" style="display:none" accept="application/json">
    </div>
    <!-- 链接列表 -->
    <div id="linksList"></div>
  </div>
  
  <!-- 链接新增模态框 -->
  <div id="addLinkModal" style="display:none;">
    <h2>新規リンク追加</h2>
    <input type="text" id="modalLinkName" class="form-control" placeholder="リンク名">
    <input type="url" id="modalLinkURL" class="form-control" placeholder="リンクURL（http:// または https:// を含む）">
    <input type="text" id="modalLinkTags" class="form-control" placeholder="タグ（複数の場合、コンマで区切ってください）">
    <div class="modal-btns">
      <button class="btn" onclick="closeAddModal()">キャンセル</button>
      <button class="btn-add" onclick="submitNewLink()">送信</button>
    </div>
  </div>
  
  <!-- 管理者模态框 -->
  <div id="adminModal" style="display:none;">
    <h2>ユーザー管理</h2>
    <table id="adminTable">
      <thead>
        <tr>
          <th>UID</th>
          <th>メールアドレス</th>
          <th>最終ログイン</th>
          <th>管理者</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <div class="modal-btns">
      <button class="btn" onclick="downloadAllUserLinks()">全ユーザーのリンクダウンロード</button>
      <button class="btn" onclick="closeAdminModal()">閉じる</button>
    </div>
  </div>
  
  <!-- 操作等待 Spinner（全局） -->
  <div id="opSpinner" class="spinner" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index:2300;"></div>
  
  <!-- 引入 Sortable.js -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  
  <script>
    // Firebase の设置（你的 Firebase 控制台中的配置）
    var firebaseConfig = {
      apiKey: "AIzaSyCDlSoBXuNOEQOPIvx1metUAPctqt6xcFs",
      authDomain: "mylinkcollection-abe80.firebaseapp.com",
      projectId: "mylinkcollection-abe80",
      storageBucket: "mylinkcollection-abe80.firebasestorage.app",
      messagingSenderId: "909533533947",
      appId: "1:909533533947:web:b44730dff9fbec4f02425e"
    };
    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    // 设置持久化认证
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    // 定义全局变量：存储用户链接
    let links = [];
    
    // 获取 favicon 的函数（加载失败时返回空字符串）
    function getFaviconUrl(url) {
      try {
        const urlObj = new URL(url);
        return urlObj.origin + '/favicon.ico';
      } catch (e) {
        return "";
      }
    }
    
    function showOpSpinner() {
      document.getElementById('opSpinner').style.display = 'block';
    }
    function hideOpSpinner() {
      document.getElementById('opSpinner').style.display = 'none';
    }
    
    // 认证状态监听器
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await updateUserProfile(user);
        loadUserLinks();
        document.getElementById("authModal").style.display = "none";
        document.getElementById("modalOverlay").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        const userDoc = await db.collection("users").doc(user.uid).get();
        const userData = userDoc.data();
        if (userData && userData.isAdmin) {
          document.getElementById("adminBtn").style.display = "inline-block";
        } else {
          document.getElementById("adminBtn").style.display = "none";
        }
      } else {
        document.getElementById("mainContent").style.display = "none";
        openAuthModal();
      }
    });
    
    async function updateUserProfile(user) {
      const isAdmin = (user.email === "ribunnan@ribunnan.com");
      const userData = {
        email: user.email,
        lastLogin: new Date().toISOString(),
        isAdmin: isAdmin
      };
      await db.collection("users").doc(user.uid).set(userData, { merge: true });
    }
    
    // ======= 登录/注册 =======
    function openAuthModal() {
      document.getElementById("authModal").style.display = "block";
      document.getElementById("modalOverlay").style.display = "block";
      switchToLogin();
    }
    function switchToRegister() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "block";
    }
    function switchToLogin() {
      document.getElementById("registerForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    }
    
    function login() {
      const email = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) {
        alert("すべての情報を入力してください！");
        return;
      }
      const loginButton = document.getElementById("loginButton");
      const spinner = document.getElementById("loginSpinner");
      loginButton.disabled = true;
      spinner.style.display = "inline-block";
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          spinner.style.display = "none";
          loginButton.disabled = false;
        })
        .catch((error) => {
          spinner.style.display = "none";
          loginButton.disabled = false;
          alert("ログインエラー: " + error.message);
        });
    }
    
    function register() {
      const email = document.getElementById("registerUsername").value.trim();
      const password = document.getElementById("registerPassword").value;
      const confirmPassword = document.getElementById("registerPasswordConfirm").value;
      if (!email || !password || !confirmPassword) {
        alert("すべての情報を入力してください！");
        return;
      }
      if (password !== confirmPassword) {
        alert("パスワードが一致しません！");
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // 自动切换
        })
        .catch((error) => {
          alert("登録エラー: " + error.message);
        });
    }
    
    function confirmLogout() {
      if (confirm("本当にログアウトしてもよろしいですか？")) {
        logout();
      }
    }
    function logout() {
      auth.signOut().catch((error) => {
        alert("ログアウトエラー: " + error.message);
      });
    }
    
    // ======= 链接数据操作（Firestore） =======
    function loadUserLinks() {
      const user = auth.currentUser;
      if (!user) return;
      db.collection("users").doc(user.uid).collection("links").orderBy('order')
        .get()
        .then((querySnapshot) => {
          links = [];
          querySnapshot.forEach((doc) => {
            let data = doc.data();
            data.id = doc.id;
            links.push(data);
          });
          renderLinks();
        })
        .catch((error) => {
          console.error("リンクの読み込みに失敗しました:", error);
        });
    }
    
    function addLinkToFirestore(linkData) {
      const user = auth.currentUser;
      if (!user) return;
      linkData.order = Date.now();
      showOpSpinner();
      db.collection("users").doc(user.uid).collection("links")
        .add(linkData)
        .then(() => {
          hideOpSpinner();
          loadUserLinks();
          closeAddModal();
        })
        .catch((error) => {
          hideOpSpinner();
          alert("リンクの追加に失敗しました: " + error.message);
        });
    }
    
    function updateLinkInFirestore(linkId, linkData) {
      const user = auth.currentUser;
      if (!user) return;
      showOpSpinner();
      db.collection("users").doc(user.uid).collection("links").doc(linkId)
        .update(linkData)
        .then(() => {
          hideOpSpinner();
          loadUserLinks();
        })
        .catch((error) => {
          hideOpSpinner();
          alert("リンクの更新に失敗しました: " + error.message);
        });
    }
    
    function deleteLinkFromFirestore(linkId) {
      const user = auth.currentUser;
      if (!user) return;
      showOpSpinner();
      db.collection("users").doc(user.uid).collection("links").doc(linkId)
        .delete()
        .then(() => {
          hideOpSpinner();
          loadUserLinks();
        })
        .catch((error) => {
          hideOpSpinner();
          alert("リンクの削除に失敗しました: " + error.message);
        });
    }
    
    // ======= 链接卡片及列表渲染 =======
    function createLinkCard(link, index) {
      const card = document.createElement('div');
      card.className = 'link-card';
      card.setAttribute('data-id', link.id);
      
      const header = document.createElement('div');
      header.className = 'link-header';
      
      const icon = document.createElement('img');
      icon.className = 'link-icon';
      // 使用明确的相对路径访问 favicon
      icon.src = getFaviconUrl(link.url);
      icon.alt = 'favicon';
      icon.onerror = function() { this.style.display = 'none'; };
      header.appendChild(icon);
      
      const info = document.createElement('div');
      info.className = 'link-info';
      
      const linkElem = document.createElement('a');
      linkElem.href = link.url;
      linkElem.textContent = link.name;
      linkElem.target = '_blank';
      info.appendChild(linkElem);
      
      if (link.tags && link.tags.length > 0) {
        link.tags.forEach(tag => {
          const tagElem = document.createElement('span');
          tagElem.className = 'tag';
          tagElem.textContent = tag;
          info.appendChild(tagElem);
        });
      }
      header.appendChild(info);
      card.appendChild(header);
      
      const btnContainer = document.createElement('div');
      
      const editButton = document.createElement('button');
      editButton.textContent = '編集';
      editButton.className = 'btn link-btn';
      editButton.onclick = function() {
        enterEditMode(card, link, index);
      };
      btnContainer.appendChild(editButton);
      
      const deleteButton = document.createElement('button');
      deleteButton.textContent = '削除';
      deleteButton.className = 'btn';
      deleteButton.onclick = function() {
        if (confirm('このリンクを削除してもよろしいですか？')) {
          deleteLinkFromFirestore(link.id);
        }
      };
      btnContainer.appendChild(deleteButton);
      
      card.appendChild(btnContainer);
      return card;
    }
    
    function enterEditMode(card, link, index) {
      card.innerHTML = '';
      const editContainer = document.createElement('div');
      editContainer.className = 'edit-container';
      
      const nameInput = document.createElement('input');
      nameInput.value = link.name;
      nameInput.className = 'edit-input';
      nameInput.placeholder = 'リンク名';
      editContainer.appendChild(nameInput);
      
      const urlInput = document.createElement('input');
      urlInput.value = link.url;
      urlInput.className = 'edit-input';
      urlInput.placeholder = 'リンクURL（http:// または https:// を含む）';
      editContainer.appendChild(urlInput);
      
      const tagsInput = document.createElement('input');
      tagsInput.value = link.tags ? link.tags.join(', ') : '';
      tagsInput.className = 'edit-input';
      tagsInput.placeholder = 'タグ（複数の場合、コンマで区切ってください）';
      editContainer.appendChild(tagsInput);
      
      card.appendChild(editContainer);
      
      const saveButton = document.createElement('button');
      saveButton.textContent = '保存';
      saveButton.className = 'btn';
      saveButton.onclick = function() {
        const newName = nameInput.value.trim();
        const newURL = urlInput.value.trim();
        const newTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        if (newName && newURL) {
          updateLinkInFirestore(link.id, { name: newName, url: newURL, tags: newTags });
        } else {
          alert("リンク名とURLは空にできません！");
        }
      };
      card.appendChild(saveButton);
      
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'キャンセル';
      cancelButton.className = 'btn';
      cancelButton.onclick = function() {
        loadUserLinks();
      };
      card.appendChild(cancelButton);
    }
    
    function renderLinks(filteredLinks = null) {
      const listContainer = document.getElementById('linksList');
      listContainer.innerHTML = '';
      const displayLinks = filteredLinks !== null ? filteredLinks : links;
      displayLinks.forEach((link, index) => {
        const card = createLinkCard(link, index);
        listContainer.appendChild(card);
      });
      initSortable();
    }
    
    // ======= 模态框操作 =======
    function openAddModal() {
      document.getElement
