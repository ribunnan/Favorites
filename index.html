<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>リンク集</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCDlSoBXuNOEQOPIvx1metUAPctqt6xcFs",
      authDomain: "mylinkcollection-abe80.firebaseapp.com",
      projectId: "mylinkcollection-abe80",
      storageBucket: "mylinkcollection-abe80.appspot.com",
      messagingSenderId: "909533533947",
      appId: "1:909533533947:web:b44730dff9fbec4f02425e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  <style>
    /* 样式保持不变，略（你的原始 CSS 已经很好看） */
  </style>
</head>
<body>
  <!-- 认证模态框 -->
  <div id="authModal" style="display:none;">
    <div id="loginForm">
      <h2>ログイン</h2>
      <input type="email" id="loginEmail" class="form-control" placeholder="メールアドレス" />
      <input type="password" id="loginPassword" class="form-control" placeholder="パスワード" />
      <div class="modal-btns">
        <button class="btn" onclick="switchToRegister()">登録</button>
        <button class="btn-add" onclick="loginUser()">ログイン</button>
      </div>
    </div>
    <div id="registerForm" style="display:none;">
      <h2>登録</h2>
      <input type="email" id="registerEmail" class="form-control" placeholder="メールアドレス" />
      <input type="password" id="registerPassword" class="form-control" placeholder="パスワード" />
      <input type="password" id="registerPasswordConfirm" class="form-control" placeholder="パスワード確認" />
      <div class="modal-btns">
        <button class="btn" onclick="switchToLogin()">ログインに戻る</button>
        <button class="btn-add" onclick="registerUser()">登録</button>
      </div>
    </div>
  </div>
  <div id="modalOverlay" style="display:none;"></div>

  <!-- 主容器 -->
  <div class="container" id="mainContent" style="display:none;">
    <h1>リンク集</h1>
    <div class="toolbar">
      <input type="text" id="searchInput" class="form-control" placeholder="リンクを検索..." />
      <button onclick="openAddModal()">リンク追加</button>
      <button onclick="exportLinks()">データエクスポート</button>
      <button onclick="document.getElementById('importInput').click();">データインポート</button>
      <button id="themeToggle">テーマ切替</button>
      <button onclick="logoutUser()">ログアウト</button>
      <button id="adminBtn" onclick="openAdminModal()" style="display:none;">管理</button>
      <input type="file" id="importInput" style="display:none" accept="application/json" />
    </div>
    <div id="linksList"></div>
  </div>
<script>
  function switchToRegister() {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("registerForm").style.display = "block";
  }

  function switchToLogin() {
    document.getElementById("registerForm").style.display = "none";
    document.getElementById("loginForm").style.display = "block";
  }

  function openAuthModal() {
    document.getElementById("authModal").style.display = "block";
    document.getElementById("modalOverlay").style.display = "block";
  }

  function closeAuthModal() {
    document.getElementById("authModal").style.display = "none";
    document.getElementById("modalOverlay").style.display = "none";
  }

  // 注册
  function registerUser() {
    const email = document.getElementById("registerEmail").value.trim();
    const password = document.getElementById("registerPassword").value;
    const confirmPassword = document.getElementById("registerPasswordConfirm").value;

    if (!email || !password || !confirmPassword) {
      alert("すべての情報を入力してください！");
      return;
    }
    if (password !== confirmPassword) {
      alert("パスワードが一致しません！");
      return;
    }

    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        return db.collection("users").doc(user.uid).set({
          email: user.email,
          lastLogin: new Date().toISOString()
        });
      })
      .catch(error => {
        alert("登録失敗: " + error.message);
      });
  }

  // 登录
  function loginUser() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;

    if (!email || !password) {
      alert("すべての情報を入力してください！");
      return;
    }

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        // 成功后 Firebase 会自动触发 onAuthStateChanged
      })
      .catch(error => {
        alert("ログイン失敗: " + error.message);
      });
  }

  function logoutUser() {
    auth.signOut().then(() => {
      console.log("ログアウトしました");
    });
  }

  // 登录状态监听器
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("mainContent").style.display = "block";
      closeAuthModal();
      loadUserLinks();
      if (user.email === "ribunnan@ribunnan.com") {
        document.getElementById("adminBtn").style.display = "inline-block";
      } else {
        document.getElementById("adminBtn").style.display = "none";
      }
    } else {
      openAuthModal();
      document.getElementById("mainContent").style.display = "none";
    }
  });
</script>
<script>
  let links = [];

  function loadUserLinks() {
    const user = auth.currentUser;
    if (!user) return;

    db.collection("users").doc(user.uid).collection("links")
      .get()
      .then(snapshot => {
        links = [];
        snapshot.forEach(doc => {
          links.push({ id: doc.id, ...doc.data() });
        });
        renderLinks();
      })
      .catch(err => {
        console.error("リンクの読み込み失敗", err);
      });
  }

  function addLinkToFirestore(link) {
    const user = auth.currentUser;
    db.collection("users").doc(user.uid).collection("links").add(link)
      .then(() => {
        loadUserLinks();
        closeAddModal();
      });
  }

  function updateLinkInFirestore(id, data) {
    const user = auth.currentUser;
    db.collection("users").doc(user.uid).collection("links").doc(id).update(data)
      .then(() => loadUserLinks());
  }

  function deleteLinkFromFirestore(id) {
    const user = auth.currentUser;
    db.collection("users").doc(user.uid).collection("links").doc(id).delete()
      .then(() => loadUserLinks());
  }

  function openAddModal() {
    document.getElementById("modalOverlay").style.display = "block";
    document.getElementById("addLinkModal").style.display = "block";
    document.getElementById("modalLinkName").value = "";
    document.getElementById("modalLinkURL").value = "";
    document.getElementById("modalLinkTags").value = "";
  }

  function closeAddModal() {
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("addLinkModal").style.display = "none";
  }

  function submitNewLink() {
    const name = document.getElementById("modalLinkName").value.trim();
    const url = document.getElementById("modalLinkURL").value.trim();
    const tags = document.getElementById("modalLinkTags").value.trim().split(",").map(t => t.trim()).filter(Boolean);

    if (!name || !url) {
      alert("すべての情報を入力してください！");
      return;
    }

    const duplicate = links.find(l => l.url === url);
    if (duplicate) {
      if (confirm("重複リンク。上書きしますか？")) {
        updateLinkInFirestore(duplicate.id, { name, url, tags });
        closeAddModal();
      }
      return;
    }

    addLinkToFirestore({ name, url, tags });
  }
</script>
<script>
  function renderLinks(filteredLinks = null) {
    const listContainer = document.getElementById('linksList');
    listContainer.innerHTML = '';
    let displayLinks = filteredLinks !== null ? filteredLinks : links;

    displayLinks.forEach((link, index) => {
      const card = createLinkCard(link, index);
      listContainer.appendChild(card);
    });

    if (!document.getElementById('searchInput').value.trim()) {
      new Sortable(listContainer, {
        animation: 150,
        onEnd: function () {
          loadUserLinks();
        }
      });
    }
  }

  function createLinkCard(link, index) {
    const card = document.createElement('div');
    card.className = 'link-card';
    card.setAttribute('data-index', index);

    const header = document.createElement('div');
    header.className = 'link-header';

    const icon = document.createElement('img');
    icon.className = 'link-icon';
    icon.src = getFaviconUrl(link.url);
    icon.onerror = function () {
      this.src = fallbackIcon;
    };
    header.appendChild(icon);

    const info = document.createElement('div');
    info.className = 'link-info';

    const linkElem = document.createElement('a');
    linkElem.href = link.url;
    linkElem.textContent = link.name;
    linkElem.target = '_blank';
    info.appendChild(linkElem);

    if (link.tags && link.tags.length > 0) {
      link.tags.forEach(tag => {
        const tagElem = document.createElement('span');
        tagElem.className = 'tag';
        tagElem.textContent = tag;
        info.appendChild(tagElem);
      });
    }

    header.appendChild(info);
    card.appendChild(header);

    const btnContainer = document.createElement('div');

    const editBtn = document.createElement('button');
    editBtn.textContent = "編集";
    editBtn.className = "btn";
    editBtn.onclick = () => enterEditMode(card, link, index);
    btnContainer.appendChild(editBtn);

    const delBtn = document.createElement('button');
    delBtn.textContent = "削除";
    delBtn.className = "btn";
    delBtn.onclick = () => {
      if (confirm("このリンクを削除しますか？")) {
        deleteLinkFromFirestore(link.id);
      }
    };
    btnContainer.appendChild(delBtn);

    card.appendChild(btnContainer);
    return card;
  }

  function enterEditMode(card, link, index) {
    card.innerHTML = '';
    const editContainer = document.createElement('div');
    editContainer.className = 'edit-container';

    const nameInput = document.createElement('input');
    nameInput.value = link.name;
    nameInput.className = 'edit-input';
    editContainer.appendChild(nameInput);

    const urlInput = document.createElement('input');
    urlInput.value = link.url;
    urlInput.className = 'edit-input';
    editContainer.appendChild(urlInput);

    const tagsInput = document.createElement('input');
    tagsInput.value = link.tags ? link.tags.join(', ') : '';
    tagsInput.className = 'edit-input';
    editContainer.appendChild(tagsInput);

    card.appendChild(editContainer);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = "保存";
    saveBtn.className = "btn";
    saveBtn.onclick = () => {
      const newName = nameInput.value.trim();
      const newURL = urlInput.value.trim();
      const newTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
      if (newName && newURL) {
        updateLinkInFirestore(link.id, { name: newName, url: newURL, tags: newTags });
      }
    };
    card.appendChild(saveBtn);

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = "キャンセル";
    cancelBtn.className = "btn";
    cancelBtn.onclick = () => loadUserLinks();
    card.appendChild(cancelBtn);
  }

  document.getElementById('searchInput').addEventListener('input', function () {
    const query = this.value.toLowerCase().trim();
    const filtered = links.filter(link =>
      link.name.toLowerCase().includes(query) ||
      link.url.toLowerCase().includes(query) ||
      (link.tags || []).some(tag => tag.toLowerCase().includes(query))
    );
    renderLinks(filtered);
  });
</script>
<script>
  function exportLinks() {
    const dataStr = JSON.stringify(links, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "links_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  document.getElementById('importInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedLinks = JSON.parse(e.target.result);
        if (!Array.isArray(importedLinks)) {
          alert("インポート形式が正しくありません！");
          return;
        }

        const user = auth.currentUser;
        if (!user) return;

        db.collection("users").doc(user.uid).collection("links").get()
          .then(querySnapshot => {
            const batch = db.batch();
            querySnapshot.forEach(doc => {
              batch.delete(doc.ref);
            });
            return batch.commit();
          })
          .then(() => {
            const addPromises = importedLinks.map(link =>
              db.collection("users").doc(user.uid).collection("links").add(link)
            );
            return Promise.all(addPromises);
          })
          .then(() => {
            loadUserLinks();
            alert("インポート成功！");
          })
          .catch(err => {
            alert("インポートエラー: " + err);
          });

      } catch (err) {
        alert("ファイルが不正です: " + err);
      }
    };
    reader.readAsText(file);
  });
</script>
<script>
  function openAdminModal() {
    renderAdminData();
    document.getElementById('modalOverlay').style.display = 'block';
    document.getElementById('adminModal').style.display = 'block';
  }

  function closeAdminModal() {
    document.getElementById('modalOverlay').style.display = 'none';
    document.getElementById('adminModal').style.display = 'none';
  }

  function renderAdminData() {
    const tbody = document.getElementById('adminTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = "";

    db.collection("users").get()
      .then(querySnapshot => {
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const tr = document.createElement("tr");

          const tdUid = document.createElement("td");
          tdUid.textContent = doc.id;
          tr.appendChild(tdUid);

          const tdEmail = document.createElement("td");
          tdEmail.textContent = data.email || "N/A";
          tr.appendChild(tdEmail);

          const tdLogin = document.createElement("td");
          tdLogin.textContent = data.lastLogin || "不明";
          tr.appendChild(tdLogin);

          tbody.appendChild(tr);
        });
      })
      .catch(err => {
        alert("ユーザー情報取得エラー: " + err.message);
      });
  }

  function downloadAllUserLinks() {
    db.collection("users").get()
      .then(querySnapshot => {
        let allData = {};
        let tasks = [];

        querySnapshot.forEach(doc => {
          const uid = doc.id;
          tasks.push(
            db.collection("users").doc(uid).collection("links").get().then(linksSnap => {
              allData[uid] = [];
              linksSnap.forEach(linkDoc => {
                allData[uid].push(linkDoc.data());
              });
            })
          );
        });

        return Promise.all(tasks).then(() => allData);
      })
      .then(allData => {
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "all_users_links.json";
        a.click();
        URL.revokeObjectURL(url);
      })
      .catch(err => {
        alert("エクスポート失敗: " + err.message);
      });
  }
</script>
</body>
</html>
